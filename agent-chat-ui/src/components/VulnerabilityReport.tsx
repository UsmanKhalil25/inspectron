import { cn } from "@/lib/utils";
import { ChevronDown, ChevronRight, AlertTriangle, ShieldAlert, Info, AlertCircle } from "lucide-react";
import { useState } from "react";

interface Vulnerability {
  id: string;
  type: string;
  severity: "low" | "medium" | "high" | "critical";
  title: string;
  description: string;
  recommendation: string;
  location?: string;
  evidence?: string;
}

interface VulnerabilityReport {
  findings: Vulnerability[];
  scannedAt: string;
  url: string;
  riskLevel: "low" | "medium" | "high" | "critical";
  summary: {
    total: number;
    critical: number;
    high: number;
    medium: number;
    low: number;
  };
}

interface VulnerabilityReportProps {
  report: VulnerabilityReport;
}

const severityConfig = {
  critical: {
    color: "text-red-600 dark:text-red-400",
    bg: "bg-red-50 dark:bg-red-950/30",
    border: "border-red-200 dark:border-red-800",
    icon: ShieldAlert,
    label: "Critical",
  },
  high: {
    color: "text-orange-600 dark:text-orange-400",
    bg: "bg-orange-50 dark:bg-orange-950/30",
    border: "border-orange-200 dark:border-orange-800",
    icon: AlertTriangle,
    label: "High",
  },
  medium: {
    color: "text-yellow-600 dark:text-yellow-400",
    bg: "bg-yellow-50 dark:bg-yellow-950/30",
    border: "border-yellow-200 dark:border-yellow-800",
    icon: AlertCircle,
    label: "Medium",
  },
  low: {
    color: "text-blue-600 dark:text-blue-400",
    bg: "bg-blue-50 dark:bg-blue-950/30",
    border: "border-blue-200 dark:border-blue-800",
    icon: Info,
    label: "Low",
  },
};

function VulnerabilityItem({ vulnerability }: { vulnerability: Vulnerability }) {
  const [isExpanded, setIsExpanded] = useState(false);
  const config = severityConfig[vulnerability.severity];
  const Icon = config.icon;

  return (
    <div
      className={cn(
        "rounded-lg border p-3",
        config.border,
        config.bg,
      )}
    >
      <div
        className="flex cursor-pointer items-start gap-2"
        onClick={() => setIsExpanded(!isExpanded)}
      >
        <div className="mt-0.5">
          {isExpanded ? (
            <ChevronDown className="h-4 w-4" />
          ) : (
            <ChevronRight className="h-4 w-4" />
          )}
        </div>
        <Icon className={cn("h-5 w-5 shrink-0 mt-0.5", config.color)} />
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2 flex-wrap">
            <span className="font-medium">{vulnerability.title}</span>
            <span
              className={cn(
                "text-xs font-semibold uppercase px-2 py-0.5 rounded",
                config.color,
              )}
            >
              {config.label}
            </span>
          </div>
          {vulnerability.location && (
            <div className="text-xs text-muted-foreground mt-1">
              {vulnerability.location}
            </div>
          )}
        </div>
      </div>

      {isExpanded && (
        <div className="mt-3 ml-6 space-y-3 text-sm">
          <div>
            <div className="font-medium mb-1">Description</div>
            <div className="text-muted-foreground">{vulnerability.description}</div>
          </div>

          <div>
            <div className="font-medium mb-1">Recommendation</div>
            <div className="text-muted-foreground">{vulnerability.recommendation}</div>
          </div>

          {vulnerability.evidence && (
            <div>
              <div className="font-medium mb-1">Evidence</div>
              <div className="text-xs font-mono bg-background/50 p-2 rounded overflow-x-auto">
                {vulnerability.evidence}
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
}

export function VulnerabilityReport({ report }: VulnerabilityReportProps) {
  const riskConfig = severityConfig[report.riskLevel];
  const RiskIcon = riskConfig.icon;

  // Group vulnerabilities by severity
  const groupedVulnerabilities = {
    critical: report.findings.filter((v) => v.severity === "critical"),
    high: report.findings.filter((v) => v.severity === "high"),
    medium: report.findings.filter((v) => v.severity === "medium"),
    low: report.findings.filter((v) => v.severity === "low"),
  };

  return (
    <div className="my-4 rounded-lg border border-border bg-card p-4 space-y-4">
      {/* Header */}
      <div className="flex items-start gap-3">
        <RiskIcon className={cn("h-6 w-6 shrink-0", riskConfig.color)} />
        <div className="flex-1">
          <h3 className="text-lg font-semibold">Security Vulnerability Report</h3>
          <div className="text-sm text-muted-foreground mt-1">
            {report.url}
          </div>
          <div className="text-xs text-muted-foreground">
            Scanned: {new Date(report.scannedAt).toLocaleString()}
          </div>
        </div>
      </div>

      {/* Summary */}
      <div
        className={cn(
          "rounded-lg border p-3",
          riskConfig.border,
          riskConfig.bg,
        )}
      >
        <div className="flex items-center gap-2 mb-2">
          <span className="font-semibold">Overall Risk Level:</span>
          <span
            className={cn(
              "text-sm font-bold uppercase px-2 py-0.5 rounded",
              riskConfig.color,
            )}
          >
            {riskConfig.label}
          </span>
        </div>
        <div className="grid grid-cols-2 sm:grid-cols-5 gap-2 text-sm">
          <div>
            <span className="font-medium">Total:</span> {report.summary.total}
          </div>
          {report.summary.critical > 0 && (
            <div className={severityConfig.critical.color}>
              <span className="font-medium">Critical:</span> {report.summary.critical}
            </div>
          )}
          {report.summary.high > 0 && (
            <div className={severityConfig.high.color}>
              <span className="font-medium">High:</span> {report.summary.high}
            </div>
          )}
          {report.summary.medium > 0 && (
            <div className={severityConfig.medium.color}>
              <span className="font-medium">Medium:</span> {report.summary.medium}
            </div>
          )}
          {report.summary.low > 0 && (
            <div className={severityConfig.low.color}>
              <span className="font-medium">Low:</span> {report.summary.low}
            </div>
          )}
        </div>
      </div>

      {/* Findings */}
      <div className="space-y-2">
        <h4 className="font-semibold text-sm">Findings</h4>

        {/* Critical */}
        {groupedVulnerabilities.critical.length > 0 && (
          <div className="space-y-2">
            {groupedVulnerabilities.critical.map((vuln) => (
              <VulnerabilityItem key={vuln.id} vulnerability={vuln} />
            ))}
          </div>
        )}

        {/* High */}
        {groupedVulnerabilities.high.length > 0 && (
          <div className="space-y-2">
            {groupedVulnerabilities.high.map((vuln) => (
              <VulnerabilityItem key={vuln.id} vulnerability={vuln} />
            ))}
          </div>
        )}

        {/* Medium */}
        {groupedVulnerabilities.medium.length > 0 && (
          <div className="space-y-2">
            {groupedVulnerabilities.medium.map((vuln) => (
              <VulnerabilityItem key={vuln.id} vulnerability={vuln} />
            ))}
          </div>
        )}

        {/* Low */}
        {groupedVulnerabilities.low.length > 0 && (
          <div className="space-y-2">
            {groupedVulnerabilities.low.map((vuln) => (
              <VulnerabilityItem key={vuln.id} vulnerability={vuln} />
            ))}
          </div>
        )}
      </div>

      {report.findings.length === 0 && (
        <div className="text-center py-4 text-muted-foreground">
          No vulnerabilities detected
        </div>
      )}
    </div>
  );
}
